{% extends "base.html" %}
{% block title %}Jogar ‚Äî Hearts & Swords{% endblock %}

{% block head %}
<script>
let RUN_ID = null;
let CURRENT_RUN = null;

function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  if (match) return decodeURIComponent(match[2]);
  return null;
}
async function api(url, method='GET', body=null){
  const headers = { 'Content-Type': 'application/json' };
  const csrf = getCookie('csrftoken');
  if (csrf) headers['X-CSRFToken'] = csrf;
  const res = await fetch(url, { method, headers, body: body?JSON.stringify(body):null });
  if(!res.ok){
    let t = await res.text();
    try { const j = JSON.parse(t); t = j.detail || t; } catch{}
    throw new Error(t || (res.status+' '+res.statusText));
  }
  return await res.json();
}

function valFromRank(rank){
  if (typeof rank === 'number') return rank;
  const map = { 'J':11, 'Q':12, 'K':13, 'A':14 };
  return map[rank] ?? 0;
}
function suitIcon(s){
  const map = { clubs:'‚ô£Ô∏è', spades:'‚ô†Ô∏è', hearts:'‚ô•Ô∏è', diamonds:'‚ô¶Ô∏è' };
  return map[s] || s;
}
function typeLabel(t){ return t==='enemy'?'Inimigo':(t==='weapon'?'Arma':'Cura'); }

function renderRun(run){
  CURRENT_RUN = run;
  RUN_ID = run.id || RUN_ID;
  document.getElementById('runId').textContent = RUN_ID || '‚Äî';
  document.getElementById('hp').textContent = `${run.hp}/${run.max_hp}`;
  document.getElementById('turn').textContent = run.turn;
  document.getElementById('status').textContent = run.status;
  document.getElementById('power').textContent = run.power ?? 0;
  document.getElementById('score').textContent = run.score_total ?? 0;
  document.getElementById('emptied').textContent = run.emptied_this_turn ?? 0;

  // board
  const boardEl = document.getElementById('board');
  boardEl.innerHTML = '';
  (run.board || []).forEach((slot, i) => {
    const slotEl = document.createElement('div');
    slotEl.className = 'slot';

    if (!slot) {
      slotEl.innerHTML = `<div class="top"><div class="badge">Vazio</div><div class="muted mono">#${i+1}</div></div><div class="muted">‚Äî</div>`;
      boardEl.appendChild(slotEl);
      return;
    }

    const c = slot.card;
    const type = slot.type;
    const held = slot.held || 0;
    const val = type==='enemy' ? valFromRank(c.rank) : valFromRank(c.rank);
    const canFight = type==='enemy' && (CURRENT_RUN.power ?? 0) >= val && CURRENT_RUN.status==='ongoing';

    let badgeCls = 'badge';
    if (type==='enemy') badgeCls += ' enemy';
    if (type==='weapon') badgeCls += ' weapon';
    if (type==='heal') badgeCls += ' heal';

    slotEl.innerHTML = `
      <div class="top">
        <div class="${badgeCls}">${typeLabel(type)}</div>
        <div class="muted mono">slot #${i+1}</div>
      </div>
      <div>
        <h3 class="title">${suitIcon(c.suit)} <span class="mono">${c.rank}</span> <span class="muted">(${val})</span></h3>
        ${type==='enemy' ? `<div class="held">Mantido: ${held}/2 turnos</div>` : ''}
        <div class="actions">
          ${type==='weapon' ? `
            <button class="btn ok" onclick="equipSlot(${i})">Equipar ‚ô¶Ô∏è${val}</button>
            <button class="btn secondary" onclick="discardSlot(${i})">Descartar</button>
          ` : ''}
          ${type==='heal' ? `
            <button class="btn ok" onclick="useHeal(${i})">Usar ‚ô•Ô∏è${val}</button>
            <button class="btn secondary" onclick="discardSlot(${i})">Descartar</button>
          ` : ''}
          ${type==='enemy' ? `
            <button class="btn ${canFight?'ok':'secondary'}" onclick="fightSlot(${i})" ${canFight?'':'disabled'}>Lutar (${val})</button>
            <button class="btn danger" onclick="payLife(${i})">Pagar Vida ${val}</button>
          ` : ''}
        </div>
      </div>
    `;
    boardEl.appendChild(slotEl);
  });

  // end turn button state
  const canEnd = (run.emptied_this_turn||0) >= 2 && validateBoardForEnd(run);
  document.getElementById('endTurn').disabled = !canEnd;

  // status banner
  const banner = document.getElementById('banner');
  banner.innerHTML = run.status==='lost'
    ? `<div class="card" style="border-color:#5a2b2b;background:#221416">Voc√™ caiu em batalha. üòµ</div>`
    : run.status==='won'
      ? `<div class="card" style="border-color:#2b5a3a;background:#142219">Vit√≥ria! üèÜ</div>`
      : '';
}
function validateBoardForEnd(run){
  // n√£o pode haver arma em slots ao terminar o turno
  const hasWeapon = (run.board||[]).some(s => s && s.type==='weapon');
  if (hasWeapon) return false;
  // inimigos podem ser mantidos at√© 2 turnos (o backend tamb√©m valida)
  return true;
}

function log(msg){
  const el = document.getElementById('log');
  const time = new Date().toLocaleTimeString();
  el.innerHTML = `<div>‚Ä¢ [${time}] ${msg}</div>` + el.innerHTML;
}

// ---- API actions ----
async function startRun(ev){
  ev.preventDefault();
  const seed = document.getElementById('seed').value || 'demo';
  const max_hp = parseInt(document.getElementById('maxhp').value || '20',10);
  const data = await api('/api/start','POST',{seed,max_hp});
  renderRun(data);
  log(`Run iniciada (seed=${seed})`);
}
async function fetchRun(){
  if(!RUN_ID) return;
  const data = await api(`/api/run/${RUN_ID}`,'GET');
  renderRun(data);
}

async function equipSlot(i){
  const data = await api(`/api/run/${RUN_ID}/equip/${i}`,'POST');
  renderRun(data);
  log(`Equipou arma do slot ${i+1}`);
}
async function discardSlot(i){
  const data = await api(`/api/run/${RUN_ID}/discard/${i}`,'POST');
  renderRun(data);
  log(`Descartou carta do slot ${i+1}`);
}
async function useHeal(i){
  const data = await api(`/api/run/${RUN_ID}/use_heal/${i}`,'POST');
  renderRun(data);
  log(`Usou cura do slot ${i+1}`);
}
async function fightSlot(i){
  try{
    const data = await api(`/api/run/${RUN_ID}/fight/${i}`,'POST');
    renderRun(data);
    log(`Lutou com inimigo do slot ${i+1}`);
  }catch(e){
    alert(e.message);
  }
}
async function payLife(i){
  if(!confirm('Confirmar: pagar vida para descartar este inimigo?')) return;
  const data = await api(`/api/run/${RUN_ID}/pay_life/${i}`,'POST');
  renderRun(data);
  log(`Pagou vida e descartou inimigo do slot ${i+1}`);
}
async function endTurn(){
  try{
    const data = await api(`/api/run/${RUN_ID}/end_turn`,'POST');
    renderRun(data);
    log(`Fim do turno. Novo turno: ${data.turn}`);
  }catch(e){
    alert(e.message);
  }
}
</script>
{% endblock %}

{% block body %}
  <section class="card">
    <h2 style="margin:0 0 8px">Jogo</h2>
    <form onsubmit="startRun(event)">
      <div class="grid cols-3">
        <label>Seed<br><input id="seed" placeholder="demo-001" style="width:100%"></label>
        <label>Max HP<br><input id="maxhp" type="number" value="20" min="1" style="width:100%"></label>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn">Iniciar run</button>
          <button type="button" class="btn secondary" onclick="fetchRun()">Atualizar</button>
        </div>
      </div>
    </form>
  </section>

  <div class="space"></div>

  <section class="card">
    <div class="kpi">
      <div class="chip"><strong>Run:</strong> <span id="runId" class="mono">‚Äî</span></div>
      <div class="chip"><strong>HP:</strong> <span id="hp" class="mono">‚Äî</span></div>
      <div class="chip"><strong>Turno:</strong> <span id="turn" class="mono">‚Äî</span></div>
      <div class="chip"><strong>Status:</strong> <span id="status" class="mono">‚Äî</span></div>
      <div class="chip"><strong>Power:</strong> <span id="power" class="mono">0</span></div>
      <div class="chip"><strong>Score:</strong> <span id="score" class="mono">0</span></div>
      <div class="chip"><strong>Slots esvaziados:</strong> <span id="emptied" class="mono">0</span>/2</div>
    </div>
    <div class="space"></div>
    <div id="banner"></div>
    <div class="space"></div>
    <div id="board" class="grid cols-4">
      <!-- slots renderizados por JS -->
    </div>
    <div class="space"></div>
    <button id="endTurn" class="btn" onclick="endTurn()" disabled>Encerrar turno & Reabastecer</button>
  </section>

  <div class="space"></div>

  <section class="card">
    <h3 style="margin:0 0 8px">Log</h3>
    <div id="log" class="muted"></div>
  </section>
{% endblock %}
